<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAWAN BISA - SIDOARJO</title>
    
    <!-- Menggunakan Tailwind CSS untuk styling modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Menggunakan Google Fonts untuk tipografi yang bersih -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Menggunakan Heroicons untuk ikon -->
    <script src="https://unpkg.com/heroicons@2.1.3/24/outline/index.js"></script>

    <!-- Menambahkan library Leaflet.js untuk Peta -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Style kustom untuk aplikasi */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Memberi efek scroll yang halus */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        /* Kustomisasi scrollbar agar lebih modern */
        .chat-window::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        .chat-window::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* bg-slate-300 */
            border-radius: 3px;
        }
        .chat-window::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* bg-slate-400 */
        }
        .tab-icon-active {
            color: #3b82f6; /* blue-500 */
        }
        /* Style untuk container peta */
        #map {
            height: 300px;
            border-radius: 0.5rem;
        }
        .bot-response ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-top: 8px;
        }
        .bot-response li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">

    <!-- Kontainer utama aplikasi, dibuat menyerupai tampilan mobile -->
    <div class="max-w-md mx-auto h-screen flex flex-col bg-slate-100 shadow-2xl">

        <!-- Header Aplikasi -->
        <header class="bg-white/80 backdrop-blur-sm p-4 border-b border-slate-200 z-10">
            <div class="flex justify-between items-center">
                <!-- Logo PSI di Kiri -->
                <div class="w-1/4 flex justify-start">
                    <a href="https://www.instagram.com/dpdpsisidoarjo/" target="_blank" rel="noopener noreferrer" class="transition-transform duration-200 hover:scale-110" title="Kunjungi Instagram PSI Sidoarjo">
                        <img src="logo-psi.png" alt="Logo PSI" class="rounded-full">
                    </a>
                </div>
                <!-- Tengah: Judul -->
                <div class="w-1/2 text-center">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-500 to-red-500 bg-clip-text text-transparent">KAWAN BISA</h1>
                    <p class="text-xs text-gray-500 mt-1">Kolaborasi PSI DPD SIDOARJO X BNN SIDOARJO</p>
                    <p id="datetime" class="text-[10px] text-gray-400 mt-1"></p>
                </div>
                <!-- Logo BNN di Kanan -->
                <div class="w-1/4 flex justify-end">
                     <a href="https://www.instagram.com/infobnn_kab_sidoarjo/?hl=en" target="_blank" rel="noopener noreferrer" class="transition-transform duration-200 hover:scale-110" title="Kunjungi Instagram BNN Sidoarjo">
                        <img src="logo-bnn.png" alt="Logo BNN" class="rounded-full">
                    </a>
                </div>
            </div>
        </header>

        <!-- Konten Utama (dapat diganti sesuai tab) -->
        <main class="flex-grow overflow-y-auto p-4 pb-20">
            
            <!-- KONTEN 1: CHATBOT (Default) -->
            <div id="chat-content" class="h-full flex flex-col">
                <div id="chat-window" class="flex-grow space-y-4 overflow-y-auto smooth-scroll chat-window pr-2">
                    <div class="flex items-start gap-3">
                        <div class="bg-red-500 text-white p-2 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 0 0 2.25-2.25V8.25a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 8.25v10.5A2.25 2.25 0 0 0 6.75 21Z" /></svg>
                        </div>
                        <div>
                            <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm">
                                <p class="text-sm">Hai! Aku KAWAN BISA. Pilih topik di bawah atau ketik pertanyaanmu untuk memulai.</p>
                            </div>
                            <!-- PERUBAHAN: Tombol aksi cepat baru yang lebih lengkap -->
                            <div id="quick-actions" class="mt-2 flex flex-wrap gap-2">
                                <button onclick="sendQuickAction('Apa itu Narkoba?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Apa itu Narkoba?</button>
                                <button onclick="sendQuickAction('Jenis-jenis Narkoba')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Jenis-jenis</button>
                                <button onclick="sendQuickAction('Ciri-ciri pengguna narkoba')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Ciri Pengguna</button>
                                <button onclick="sendQuickAction('Efek samping berbagai jenis narkoba')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Efek Samping</button>
                                <button onclick="sendQuickAction('Berapa lama efek narkoba di tubuh?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Durasi Efek</button>
                                <button onclick="sendQuickAction('Apa efek sosial dari narkoba?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Efek Sosial</button>
                                <button onclick="sendQuickAction('Jelaskan pasal hukum narkoba di Indonesia')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Info Hukum</button>
                                <button onclick="sendQuickAction('Bagaimana proses rehabilitasi?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Proses Rehab</button>
                                <button onclick="sendQuickAction('Apa strategi untuk berhenti dari narkoba?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Strategi Berhenti</button>
                                <button onclick="sendQuickAction('Bagaimana cara menghindari ajakan narkoba?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Cara Menghindari</button>
                                <button onclick="sendQuickAction('Kegiatan positif untuk hindari narkoba?')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-full transition">Kegiatan Positif</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <input type="text" id="chat-input" class="flex-grow bg-white border border-slate-300 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ketik pesanmu di sini...">
                    <button id="send-button" onclick="sendMessage()" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full transition shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                    </button>
                </div>
            </div>

            <!-- KONTEN 2: PETA RISIKO & POTENSI -->
            <div id="peta-content" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Peta Risiko & Potensi Sidoarjo</h2>
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <div id="map" class="mb-4 bg-slate-200"></div>
                    <p class="text-sm text-gray-600 mb-4">Peta ini menunjukkan lokasi-lokasi kegiatan positif dan area yang memerlukan perhatian khusus di Sidoarjo. Data bersifat ilustratif.</p>
                    <div class="flex justify-around">
                        <div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-500 rounded-full border border-white"></div><span class="text-xs">Zona Potensi Positif</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 bg-yellow-500 rounded-full border border-white"></div><span class="text-xs">Zona Perhatian</span></div>
                    </div>
                </div>
            </div>

            <!-- KONTEN 3: LAPOR ANONIM -->
            <div id="lapor-content" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Lapor Cepat</h2>
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <p class="text-sm text-gray-600 mb-4">Lihat aktivitas mencurigakan? Laporkan di sini. Laporan Anda akan diteruskan ke pihak berwenang.</p>
                    <form id="lapor-form" class="space-y-4">
                        <div><label for="lapor-nama" class="block text-sm font-medium text-gray-700">Nama Pelapor</label><input type="text" id="lapor-nama" class="w-full mt-1 bg-slate-100 border border-slate-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama Anda (opsional)"></div>
                        <div><label for="lapor-telepon" class="block text-sm font-medium text-gray-700">No. Telepon</label><input type="tel" id="lapor-telepon" class="w-full mt-1 bg-slate-100 border border-slate-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nomor yang bisa dihubungi (opsional)"></div>
                        <div><label for="lapor-alamat" class="block text-sm font-medium text-gray-700">Alamat Pelapor</label><input type="text" id="lapor-alamat" class="w-full mt-1 bg-slate-100 border border-slate-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Alamat Anda (opsional)"></div>
                        <div><label for="lapor-deskripsi" class="block text-sm font-medium text-gray-700">Deskripsi Kejadian</label><textarea id="lapor-deskripsi" rows="4" class="w-full mt-1 bg-slate-100 border border-slate-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Jelaskan apa yang kamu lihat..." required></textarea></div>
                        <div><label for="lapor-lokasi" class="block text-sm font-medium text-gray-700">Perkiraan Lokasi Kejadian</label><input type="text" id="lapor-lokasi" class="w-full mt-1 bg-slate-100 border border-slate-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Dekat Alun-Alun Sidoarjo" required></div>
                        <button type="button" onclick="kirimLaporan()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md hover:shadow-lg">Kirim Laporan via Email</button>
                    </form>
                </div>
            </div>
            
            <!-- KONTEN 4: BANTUAN & KLINIK DIGITAL -->
            <div id="bantuan-content" class="hidden">
                <h2 class="text-lg font-semibold mb-4">Bantuan & Informasi Sidoarjo</h2>
                <div class="mb-6"><p class="text-center text-sm text-gray-600 mb-2">Butuh bantuan segera? Hubungi Hotline BNN.</p><a href="tel:123-456-789" class="block w-full text-center bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition animate-pulse shadow-lg">TOMBOL DARURAT</a></div>
                
                <div class="space-y-4">
                    <div><h3 class="font-semibold mb-2 text-red-500">Kantor DPD PSI Sidoarjo</h3><div class="bg-white rounded-lg p-4 text-sm shadow-md"><p>Jl. Cemeng Bakalan No.184 11, RW.02, Cemeng, Cemeng Bakalan, Kec. Sidoarjo, Kabupaten Sidoarjo, Jawa Timur 61234</p><p class="mt-2 font-semibold">Kontak: 0823-3543-3354 (Sekretariat)</p></div></div>
                    <div><h3 class="font-semibold mb-2 text-blue-500">Kantor BNN Kabupaten Sidoarjo</h3><div class="bg-white rounded-lg p-4 text-sm shadow-md"><p>Jalan Perum Taman Pinang, Blok AA8, Nomor 1A, Kwadengan Barat, Lemahputro, Kec. Sidoarjo, Kabupaten Sidoarjo, Jawa Timur 61213</p></div></div>
                </div>

                <h3 class="font-semibold mt-6 mb-3">Lembaga Bantuan Hukum (LBH)</h3>
                <div class="space-y-3">
                    <div class="bg-white rounded-lg p-4 shadow-md"><h4 class="font-semibold text-blue-500">LBH Sidoarjo</h4><p class="text-sm text-gray-600 mt-1">Menyediakan konsultasi dan pendampingan hukum. (Alamat & kontak perlu diverifikasi lebih lanjut)</p></div>
                </div>

                <h3 class="font-semibold mt-6 mb-3">Klinik & Layanan Rehabilitasi</h3>
                <div class="space-y-3">
                    <div class="bg-white rounded-lg p-4 shadow-md"><h4 class="font-semibold text-blue-500">Klinik Pratama BNN Sidoarjo</h4><p class="text-sm text-gray-600 mt-1">Jl. Perum Taman Pinang Blok AA8, No. 1A, Sidoarjo</p></div>
                    <div class="bg-white rounded-lg p-4 shadow-md"><h4 class="font-semibold text-blue-500">RSUD Sidoarjo</h4><p class="text-sm text-gray-600 mt-1">Menyediakan layanan rehabilitasi medis.</p></div>
                </div>
            </div>
        </main>

        <!-- Navigasi Bawah (Tab Bar) -->
        <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 backdrop-blur-sm border-t border-slate-200">
            <nav class="flex justify-around p-2">
                <button id="tab-chat" onclick="showTab('chat')" class="tab-button flex flex-col items-center text-gray-500 hover:text-blue-500 transition tab-icon-active"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg><span class="text-xs mt-1">Chat</span></button>
                <button id="tab-peta" onclick="showTab('peta')" class="tab-button flex flex-col items-center text-gray-500 hover:text-blue-500 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.5-10.5h-7a2.25 2.25 0 0 0-2.25 2.25v10.5a2.25 2.25 0 0 0 2.25 2.25h7.5a2.25 2.25 0 0 0 2.25-2.25V8.25a2.25 2.25 0 0 0-2.25-2.25H15M3 12h3m12 0h3" /></svg><span class="text-xs mt-1">Peta</span></button>
                <button id="tab-lapor" onclick="showTab('lapor')" class="tab-button flex flex-col items-center text-gray-500 hover:text-blue-500 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg><span class="text-xs mt-1">Lapor</span></button>
                <button id="tab-bantuan" onclick="showTab('bantuan')" class="tab-button flex flex-col items-center text-gray-500 hover:text-blue-500 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg><span class="text-xs mt-1">Bantuan</span></button>
            </nav>
        </footer>
    </div>
    
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-xl">
            <p id="modal-message" class="text-gray-800 mb-4"></p>
            <button onclick="closeModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Tutup</button>
        </div>
    </div>

    <script>
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        function showModal(message) { modalMessage.textContent = message; modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); }

        const tabs = ['chat', 'peta', 'lapor', 'bantuan'];
        const tabButtons = {};
        const tabContents = {};
        let mapInitialized = false;

        tabs.forEach(tab => {
            tabButtons[tab] = document.getElementById(`tab-${tab}`);
            tabContents[tab] = document.getElementById(`${tab}-content`);
        });

        function showTab(tabName) {
            tabs.forEach(tab => {
                tabContents[tab].classList.add('hidden');
                tabButtons[tab].classList.remove('tab-icon-active');
            });
            tabContents[tabName].classList.remove('hidden');
            tabButtons[tabName].classList.add('tab-icon-active');
            if (tabName === 'peta' && !mapInitialized) { initMap(); mapInitialized = true; }
        }

        function initMap() {
            // PERUBAHAN PETA: Koordinat Sidoarjo
            const sidoarjoCoords = [-7.4478, 112.7183];
            const map = L.map('map').setView(sidoarjoCoords, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);
            const yellowIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
            const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
            
            // PERUBAHAN PETA: Contoh marker di Sidoarjo
            L.marker([-7.455, 112.715], {icon: yellowIcon}).addTo(map).bindPopup('<b>Contoh Zona Perhatian</b><br>Area ini memerlukan kewaspadaan bersama.');
            L.marker([-7.444, 112.720], {icon: greenIcon}).addTo(map).bindPopup('<b>Alun-Alun Sidoarjo</b><br>Pusat kegiatan positif dan komunitas.');
            L.marker([-7.430, 112.710], {icon: greenIcon}).addTo(map).bindPopup('<b>GOR Delta Sidoarjo</b><br>Area untuk kegiatan olahraga.');
        }

        function kirimLaporan() {
            const nama = document.getElementById('lapor-nama').value;
            const telepon = document.getElementById('lapor-telepon').value;
            const alamat = document.getElementById('lapor-alamat').value;
            const deskripsi = document.getElementById('lapor-deskripsi').value;
            const lokasi = document.getElementById('lapor-lokasi').value;
            if (!deskripsi || !lokasi) { showModal('Deskripsi kejadian dan lokasi kejadian wajib diisi.'); return; }
            const subject = encodeURIComponent('Laporan Cepat dari Aplikasi KAWAN BISA');
            const body = encodeURIComponent(`Laporan Baru:\n\nNama Pelapor: ${nama || 'Tidak diisi'}\nNo. Telepon: ${telepon || 'Tidak diisi'}\nAlamat Pelapor: ${alamat || 'Tidak diisi'}\n\n-----------------------------------\nLOKASI KEJADIAN:\n${lokasi}\n\nDESKRIPSI KEJADIAN:\n${deskripsi}`);
            window.location.href = `mailto:aden.setyo91@gmail.com?subject=${subject}&body=${body}`;
            showModal('Anda akan diarahkan ke aplikasi email. Silakan kirim email tersebut.');
            document.getElementById('lapor-form').reset();
        }

        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

        async function sendMessage() {
            const userInput = chatInput.value.trim();
            if (userInput === '') return;

            appendMessage(userInput, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendButton.disabled = true;

            showTypingIndicator();

            try {
                const botResponse = await getBotResponse(userInput);
                hideTypingIndicator();
                appendMessage(botResponse, 'bot');
            } catch (error) {
                hideTypingIndicator();
                appendMessage('Maaf, terjadi kesalahan saat menghubungi AI. Coba lagi nanti.', 'bot');
                console.error('Error fetching AI response:', error);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }
        
        async function sendQuickAction(text) {
            appendMessage(text, 'user');
            chatInput.disabled = true;
            sendButton.disabled = true;
            
            showTypingIndicator();

            try {
                const botResponse = await getBotResponse(text);
                hideTypingIndicator();
                appendMessage(botResponse, 'bot');
            } catch (error) {
                hideTypingIndicator();
                appendMessage('Maaf, terjadi kesalahan saat menghubungi AI. Coba lagi nanti.', 'bot');
                console.error('Error fetching AI response:', error);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        function appendMessage(message, sender) {
            const messageElement = document.createElement('div');
            if (sender === 'user') {
                messageElement.className = 'flex justify-end';
                messageElement.innerHTML = `<div class="bg-blue-500 text-white rounded-lg rounded-br-none p-3 max-w-xs shadow"><p class="text-sm">${message}</p></div>`;
            } else {
                messageElement.className = 'flex items-start gap-3';
                messageElement.innerHTML = `<div class="bg-red-500 text-white p-2 rounded-full flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 0 0 2.25-2.25V8.25a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 8.25v10.5A2.25 2.25 0 0 0 6.75 21Z" /></svg></div><div class="bg-white rounded-lg rounded-tl-none p-3 max-w-xs bot-response shadow-sm"><div class="text-sm text-gray-800">${message}</div></div>`;
            }
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.id = 'typing-indicator';
            typingElement.className = 'flex items-start gap-3';
            typingElement.innerHTML = `<div class="bg-red-500 text-white p-2 rounded-full flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 0 0 2.25-2.25V8.25a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 8.25v10.5A2.25 2.25 0 0 0 6.75 21Z" /></svg></div><div><div class="bg-white rounded-lg rounded-tl-none p-3 max-w-xs shadow-sm"><div class="flex items-center gap-1"><span class="w-2 h-2 bg-slate-300 rounded-full animate-bounce" style="animation-delay: 0s;"></span><span class="w-2 h-2 bg-slate-300 rounded-full animate-bounce" style="animation-delay: 0.1s;"></span><span class="w-2 h-2 bg-slate-300 rounded-full animate-bounce" style="animation-delay: 0.2s;"></span></div></div></div>`;
            chatWindow.appendChild(typingElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
        }

        // --- "MESIN" AI DENGAN KONEKSI KE GEMINI API ---
        async function getBotResponse(userInput) {
            // Peran dan konteks untuk AI
            const systemPrompt = `Anda adalah "KAWAN BISA", chatbot AI yang ramah, informatif, dan non-menghakimi, hasil kolaborasi PSI DPD SIDOARJO dan BNN SIDOARJO. Misi Anda adalah memberikan informasi akurat dan dukungan terkait bahaya narkoba, rehabilitasi, hukum yang berlaku di Indonesia, dan cara hidup sehat. Jawablah pertanyaan pengguna dalam Bahasa Indonesia dengan jelas, empatik, dan berdasarkan fakta. Selalu pertahankan persona sebagai teman yang bisa dipercaya. Jangan pernah memberikan nasihat medis yang menggantikan dokter. Jika topik sangat sensitif atau mengindikasikan krisis, sarankan untuk menghubungi profesional atau hotline darurat yang ada di menu Bantuan.`;
            
            const chatHistory = [
                { role: "user", parts: [{ text: systemPrompt + "\n\nPertanyaan Pengguna: " + userInput }] }
            ];

            // Kunci API sengaja dikosongkan. Canvas akan mengisinya secara otomatis.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    temperature: 0.7,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 8192,
                },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                // Mengganti format markdown **tebal** menjadi tag <strong> HTML
                let text = result.candidates[0].content.parts[0].text;
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                return text;
            } else {
                return "Maaf, saya tidak bisa memproses jawaban saat ini. Coba lagi nanti.";
            }
        }
        
        // Fungsi untuk menampilkan tanggal dan jam
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options) + ' WIB';
        }

        window.onload = () => { 
            showTab('chat'); 
            updateDateTime();
            setInterval(updateDateTime, 60000); // Update setiap menit
        };
    </script>

</body>
</html>
